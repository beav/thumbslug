# Generated by Buildr 1.4.5, change to your liking


# Version number for this release
VERSION_NUMBER = "1.0.0"
# Group identifier for your projects
GROUP = "thumbslug"
COPYRIGHT = ""

# Specify Maven 2.0 remote repositories here, like this:
repositories.remote << "http://www.ibiblio.org/maven2/"
repositories.remote << "https://repository.jboss.org/nexus/content/repositories/releases/"
# for akuma
repositories.remote << "http://download.java.net/maven/2/"

require 'buildr/checkstyle'
require 'rspec/core/rake_task'

NETTY = transitive 'org.jboss.netty:netty:jar:3.2.4.Final'
LOG4J = 'log4j:log4j:jar:1.2.14'
DAEMON = transitive 'com.sun.akuma:akuma:jar:1.4'

JUNIT = 'junit:junit:jar:4.5'
MOCKITO = 'org.mockito:mockito-all:jar:1.8.5'

desc "The Thumbslug project"
define "thumbslug" do

  project.version = VERSION_NUMBER
  project.group = GROUP
  manifest["Implementation-Vendor"] = COPYRIGHT
  manifest["Main-Class"] = "org.candlepin.thumbslug.Main"
  compile.with [NETTY, LOG4J, DAEMON]
  test.compile.with [NETTY, LOG4J, DAEMON]
  test.with [JUNIT, MOCKITO]

  #
  # eclipse settings
  # http://buildr.apache.org/more_stuff.html#eclipse
  #
  eclipse.natures 'org.eclipse.jdt.core.javanature'
  eclipse.builders 'org.eclipse.jdt.core.javabuilder'

  # include netty (and deps) in the jar, so it can run standalone
  package(:jar).merge NETTY
  package(:jar).merge LOG4J
  package(:jar).merge DAEMON
end

task :serve do
    sh "java -jar target/#{GROUP}-#{VERSION_NUMBER}.jar"
end
task :serve => :package


#==========================================================================
# RSpec functional tests
#==========================================================================
RSpec::Core::RakeTask.new do |task|

  # Support optional features env variable, specify the spec files to run
  # without the trailing '_spec.rb'. Specify multiple by separating with ':'.
  # i.e. build spec features=flex_expiry:authorization
  features = ENV['features']
  if not features.nil?
    feature_files = Array.new
    features.split(":").each do |part|
      feature_files << "spec/#{part}_spec.rb"
    end
    task.pattern = feature_files
  end

  #  task.rspec_opts = ["-I#{File.expand_path '../client/ruby/'}"]
  task.rspec_opts = ['-c']
  skipbundler = ENV['skipbundler']
  if not skipbundler.nil?
      task.skip_bundler = true
  end

  # Allow specify only="should do something" to run only a specific
  # test. The text must completely match the contents of your "it" string.
  only_run = ENV['only']
  if not only_run.nil?
    task.rspec_opts << "-e '#{only_run}'"
  end

  dots = ENV['dots']
  if not dots.nil?
    task.rspec_opts << "-fp"
  else
    task.rspec_opts << "-fd"
  end
end
task :spec => :package

# runs the eclipse task to generate the .classpath and .project
# files, then fixes the output.
task :eclipse do
  puts "Fixing eclipse .classpath"
  text = File.read(".classpath")
  tmp = File.new("tmp", "w")
  text = text.gsub(/output="target\/resources"/, "")
  tmp.write(text.gsub(/<\/classpath>/, "  <classpathentry path=\"#{Java.tools_jar}\" kind=\"lib\"\/>"))
  tmp.write("</classpath>")
  tmp.close()
  FileUtils.copy("tmp", ".classpath")
  File.delete("tmp")

 # make the gettext output dir to silence eclipse errors
  mkdir_p("target/generated-source")
end
